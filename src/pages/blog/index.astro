---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getCollection } from "astro:content";

// 1. Get all blog posts
const posts = (await getCollection("blog")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// 2. Group posts by Year
const postsByYear = posts.reduce(
    (acc, post) => {
        const year = post.data.pubDate.getFullYear().toString();
        if (!acc[year]) {
            acc[year] = [];
        }
        acc[year].push(post);
        return acc;
    },
    {} as Record<string, typeof posts>,
);

// 3. Get sorted years (Newest first)
const years = Object.keys(postsByYear).sort((a, b) => parseInt(b) - parseInt(a));
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead title="Blog | Sirius" description="Archive of my thoughts." />
    </head>
    <body class="flex flex-col text-skin-base min-h-screen">
        <Header />

        <main class="flex flex-col grow w-full max-w-3xl mx-auto px-6 py-12">
            {
                years.map((year) => (
                    <section class="mb-12">
                        <h4 class="font-bold text-2xl text-skin-accent-dark mb-6 border-b border-slate-200 pb-2">
                            {year}
                        </h4>

                        <ul class="space-y-4">
                            {postsByYear[year].map((post) => (
                                <li class="group">
                                    <a
                                        href={`/blog/${post.id}/`}
                                        class="flex items-baseline justify-between gap-4"
                                    >
                                        <span class="text-lg font-medium text-slate-700 group-hover:text-skin-accent transition-colors">
                                            {post.data.title}
                                        </span>

                                        <span class="hidden sm:block grow border-b border-dotted border-slate-300 opacity-50 relative -top-1" />

                                        <time
                                            datetime={post.data.pubDate.toISOString()}
                                            class="text-sm font-mono text-slate-400 shrink-0"
                                        >
                                            {post.data.pubDate.toISOString().split("T")[0]}
                                        </time>
                                    </a>
                                </li>
                            ))}
                        </ul>
                    </section>
                ))
            }
        </main>
        <Footer />
    </body>
</html>
