---
const { headings, isRoot = true } = Astro.props;

let toc = headings;

if (isRoot) {
    toc = [];
    const parentStack = [];

    headings.forEach((h) => {
        const heading = { ...h, children: [] };

        while (parentStack.length > 0 && parentStack[parentStack.length - 1].depth >= heading.depth) {
            parentStack.pop();
        }

        if (parentStack.length === 0) {
            toc.push(heading);
        } else {
            parentStack[parentStack.length - 1].children.push(heading);
        }
        parentStack.push(heading);
    });
}
---

{isRoot ? (
  <nav class="toc text-sm max-h-[calc(100vh-8rem)] overflow-y-auto no-scrollbar pt-2">
    <h3 class="font-bold text-md text-skin-base mb-4 pb-2">Table of Contents</h3>
    <ul class="space-y-3">
      {toc.map((heading) => (
        <li>
          {heading.children.length > 0 ? (
            <details open class="group">
              <summary class="list-none [&::-webkit-details-marker]:hidden cursor-pointer text-skin-base hover:text-skin-accent font-medium transition-colors">
                <a href={`#${heading.slug}`} class="toc-link inline-block w-full">{heading.text}</a>
              </summary>
              <div class="ml-4 mt-2">
                <Astro.self headings={heading.children} isRoot={false} />
              </div>
            </details>
          ) : (
            <a href={`#${heading.slug}`} class="toc-link block text-skin-base hover:text-skin-accent transition-colors">
              {heading.text}
            </a>
          )}
        </li>
      ))}
    </ul>
  </nav>
) : (
  <ul class="space-y-2">
    {toc.map((heading) => (
      <li>
        {heading.children.length > 0 ? (
          <details open class="group">
            <summary class="list-none [&::-webkit-details-marker]:hidden cursor-pointer text-skin-base hover:text-skin-accent font-medium transition-colors">
              <a href={`#${heading.slug}`} class="toc-link inline-block w-full">{heading.text}</a>
            </summary>
            <div class="ml-4 mt-2">
              <Astro.self headings={heading.children} isRoot={false} />
            </div>
          </details>
        ) : (
          <a href={`#${heading.slug}`} class="toc-link block text-skin-base hover:text-skin-accent transition-colors">
            {heading.text}
          </a>
        )}
      </li>
    ))}
  </ul>
)}

{isRoot && (
  <>
    <script>
      const initScrollSpy = () => {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              document.querySelectorAll('.toc-link').forEach(link => {
                link.classList.remove('active-toc');
              });

              const activeLink = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
              if (activeLink) {
                activeLink.classList.add('active-toc');

                const parentDetails = activeLink.closest('details');
                if (parentDetails) {
                  parentDetails.setAttribute('open', 'true');
                }
              }
            }
          });
        }, {
          rootMargin: '-100px 0px -80% 0px'
        });

        document.querySelectorAll('.prose h2, .prose h3, .prose h4, .prose h5, .prose h6').forEach((heading) => {
          observer.observe(heading);
        });
      };

      initScrollSpy();
    </script>

    <style>
      .active-toc {
        color: var(--color-skin-accent) !important;
        font-weight: 700;
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      details[open] summary ~ * {
        animation: sweep .25s ease-in-out;
      }
      @keyframes sweep {
        0%    {opacity: 0; transform: translateY(-5px)}
        100%  {opacity: 1; transform: translateY(0)}
      }
    </style>
  </>
)}
